# raft 选举过程

## 领导者选举

在raft中，一个节点有三种变化，分别是跟随者、候选者、领导者。

初始化时，所有节点都是跟随者。

一段时间后，follower没有监听到leader发来的信息，就进入候选者状态。（Candidate）

随后，候选者向其他节点发送一次投票请求，接收到的节点会回复这次投票，如果大多数都赞同，那么这个节点将成为leader，之后所有的变化都由leader决定。

----

Raft中，有两个超时时间控制选举。

1. 竞选超时：指follower成为Candidate的时间， 竞选超时一般是150毫秒到300毫秒之间的随机数。

当到达竞选超时时间后，跟随者转变为候选人角色，并进入到 选举周期，为自己发起投票，此时候选人将发送 **投票请求** 给其它节点。

如果收到请求的节点在当前选举周期中还没有投过票，则这个节点会投票给这个候选人，然后这个节点重置它的选举周期时间，重新计时。

一旦候选人获得半数以上的赞成投票，那么它将成为**领导人**

之后领导人将发送 **附加日志** 指令给跟随者，这些消息是周期性发送，也叫 心跳包（以此来保证它的领导人地位），跟随者将响应 附加日志 消息

选举周期将一直持续**直到某个跟随者没有收到心跳包并成为候选人**，多数票赞成能保证每届只有一个领导人可以当选

如果同一时间有两个候选人，则会出现**投票分裂**的情况

![投票分裂](/home/erfenjiao/Markdown/6.824/lab2/投票分裂.png)

### 投票分裂

在同一个周期里有两个节点同时发起了竞选请求， 并且每个都收到了一个跟随者的投票响应， 现在，每个候选人都有两票，并且都无法获得更多选票



## 日志复制-两次提交

每次更改指令都会先记录到节点的日志中，日至在没有提交前，不会更改节点的值。

在提交之前，leader会将变更指令同步到follower的节点日志中。

随后，leader等待，直到大多数节点记录完成并响应。

这时，leader将提交这次记录，变更存储的值。

然后，通知其他节点提交记录。

最终，达到集群状态。





一旦选举出了领导者，我们需要向所有节点通知这一消息，并需要持续维持领导人地位， 这是通过周期性的发送 ﻿附加日志 消息（心跳包）实现的

首先，一个客户端发送变化的数据给领导人

， 这条变更被添加到领导者的日志里， 然后在下一个心跳中将变更记录发送给跟随者，一旦大多数的跟随者确认了这条记录，那么这条记录就会被提交，最后将响应客户端

Raft甚至可以在网络分区的情况下保持一致。

假如我们增加了一个分区，并将A和B分为一组，C、D和E分为一组。由于分区原因，系统中出现了两个不同的领导人

现在新加一个客户端并且试着修改两个领导人的数据。

其中一个客户端将把节点B的值设置为"3"，但节点B不能同步大多数，所以他的日志记录仍为未提交，另一个客户端将修改 节点C 的值为"8"，因为可以同步大多数，所以这个操作能够成功

随后，我们修复了网络分区问题，节点B将会发现存在"更高领导人"，所以将会选择"下台"

此时，节点A和节点B将会回滚它们未提交的记录，并同步新领导人的日志。

最终，我们集群达成了一致