

[TOC]

# 大并发服务器开发课程介绍

## 服务器设计目标

### 高性能

在满负荷的情况下，能处理大量请求，可以及时、快速响应

### 高可用

保证服务器72小时不间断的服务，即使出现故障，也能及时启动备用机，实现故障转移

### 伸缩性

服务器有良好的框架、分层设计、业务分离，并且可以灵活的部署

## 分布式

负载均衡、分布式存储、分布式缓存



# 第一节 介绍

任何网络系统都可以抽象为C/S结构，包括B/S

>  B/S：浏览器，使用httpc <=(发起请求)=> httpd



## 一个典型的服务器结构

![1.1](/home/erfenjiao/learn/大并发服务器架构/截图/1.1.png)

### 提高性能

#### 1. **DAL队列服务+连接池**

解决 超出数据库连接数：使用队列，在服务器与数据库之间添加中间缓冲层（DAL），其既可以和服务器部署在一起，也可以单独一台机子部署。

![1.2](/home/erfenjiao/learn/大并发服务器架构/截图/1.2.png)

​        数据库最多处理5000个请求。

#### 2. 分离部署

如图所示，业务处理放到应用服务器层，辅助业务放到数据库中。但这种方法只能有限的降低数据库压力

![1.4 分开部署](/home/erfenjiao/learn/大并发服务器架构/截图/1.4 分开部署.png)

#### 3. **缓存**

![1.3 缓存](/home/erfenjiao/learn/大并发服务器架构/截图/1.3 缓存.png)

缓存带来新的问题：缓存同步、更新问题

解决手段：

1. 缓存time out，如果缓存失效，那么我们就需要重新从数据库里面查询，并更新缓存。但缓存与数据库信息不同步，实时性较差
2. 当app改写数据，立即更新缓存里面的数据，实时性好。
3. 缓存换页 内存不够，将不活跃的数据换出内存

> 策略：1. FIFO LRU（least recently used） LFU(least frequently used) 最不频繁的使用

4. 缓存同步与缓存换页开源实现：nosql（反sql）

   主要用来存储非关系数据、分布式缓存、redise 

   分布式缓存见下图：

![1.5 分布式缓存](/home/erfenjiao/learn/大并发服务器架构/截图/1.5 分布式缓存.png)

#### 4. 数据库读写分离

在分布式缓存基础上，仍然有大量的数据访问服务器，产生了瓶颈，特别是对数据的写操作，把数据库锁住了，导致有其他的请求过来，会阻塞等待。

解决方法：读写分离

当数据库的读操作 > 写操作，进行数据库负载均衡。

replaction机制：主库（读库）对从库进行同步

![1.6 主从数据库](/home/erfenjiao/learn/大并发服务器架构/截图/1.6 主从数据库.png)

#### 5. 应用服务器的负载均衡

增加一个任务服务器来实现，任务服务器可以监视应用服务器的负载，判断：CPU高、IO高、并发高、内存换页高

1. 应用服务器被动接收：当任务服务器查询到这些信息之后，选取负载最低的服务器进行登陆，分配任务
2. 应用服务器主动处理：更加公平，但也有缺点。如果某些应用服务器处理特定的任务，会增加任务服务器的复杂度

![1.7 应用服务器](/home/erfenjiao/learn/大并发服务器架构/截图/1.7 应用服务器.png)

多台任务处理器

![1.8](/home/erfenjiao/learn/大并发服务器架构/截图/1.8.png)

#### 6. 数据库数据分区

两种形式：分库、分表

例如：用户表、业务表、基础信息表（竖直分区）

会影响到编程逻辑，要改写DAL

常用：水平分区。一个数据库里每一列都单独分开



###  服务器性能杀手

1. 数据拷贝

需要缓存数据解决

2. 环境切换，针对线程的切换。

   考虑自己所编写的服务器，到底该使用单线程还是多线程。例如单核机器，单线程更好。多核服务器适合多线程切换

3. 内存分配，应该理性创建线程
4. 锁竞争
